![Capgemini Azure Shorts](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/capgemini-azure-shorts.png "Capgemini Azure Shorts")

## Agenda

Agenda for this project and presentation:

- briefly about [Microsoft Azure](https://azure.microsoft.com/en-us/),
- [Azure Functions](https://azure.microsoft.com/en-us/services/functions) – what are these?
- Write a simple function replying on the HTTP,
- create a similar function via [Azure Portal](https://portal.azure.com/#home),
- local function deployment to the cloud,
- another example of [Azure Function](https://azure.microsoft.com/en-us/services/functions) collaborating with other [Microsoft Azure services](https://docs.microsoft.com/en-us/azure/cloud-services/) ([Azure Cosmos DB](https://docs.microsoft.com/en-us/azure/cosmos-db/)),
- explanation of given examples and tools that were used,
- “farewell” example ([HTTP Trigger](https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook-trigger) + [Azure Cosmos DB](https://docs.microsoft.com/en-us/azure/cosmos-db/) + [Azure Queue](https://docs.microsoft.com/en-us/azure/storage/queues/) + [Azure Blob Storage](https://docs.microsoft.com/en-us/azure/storage/blobs/) + [Azure SendGrid](https://docs.microsoft.com/en-us/azure/sendgrid-dotnet-how-to-send-email) + [Twilio](https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-twilio?tabs=csharp)).

---

## Video

The whole script was presented by me during the below video:

[![Azure Shorts - Azure Functions](http://img.youtube.com/vi/er4u5HQFCtk/0.jpg)](http://www.youtube.com/watch?v=er4u5HQFCtk)

## Prerequirements

To be able to run through each example You have to have an active Azure Subscription. You can aply for one of them [here](https://account.azure.com/signup?showCatalog=True&appId=Ibiza_SubscriptionsOverviewBladeCommandBar). We wil use ![Azure Subscriuption Icon](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/azure-subscription-icon.png "Azure Subscriuption Icon")[Pay-As-You-Go Dev/Test](https://azure.microsoft.com/en-us/offers/ms-azr-0023p/) subcription for [Visual Studio](https://my.visualstudio.com) users.

![Azure Subscriuption](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/azure-subscription.png "Azure Subscriuption")

---

After obtaining the ![Azure Subscriuption Icon](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/azure-subscription-icon.png "Azure Subscriuption Icon")[Pay-As-You-Go Dev/Test](https://azure.microsoft.com/en-us/offers/ms-azr-0023p/) subscription and cloning this repository head towards: <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_folder_black_24px.svg" width="12" /> **AzureFunctions** > <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_folder_black_24px.svg" width="12" /> **Scripts** directory and run all scripts there. Remember that to run those scripts, You have to have [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/?view=azure-cli-latest) installed:

- <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **Http-Trigger-Resource-Group.ps1**
- <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **Http-Db-Trigger-Resource-Group.ps1**
- <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **Http-Process-Resource-Group.ps1**

After they are executed we should have a final set of Azure resources:

![Azure Resources](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/all-resources.png "Azure Resources")

---

To be able to run Azure Functions locally, You also have to have [Azure Functions Core Tools](https://docs.microsoft.com/pl-pl/azure/azure-functions/functions-run-local?tabs=windows%2Ccsharp%2Cbash) installed.

---

## HTTP Trigger Demo

This is a set of simple applications that will return an array of **five** of randomly generated **WeatherForecasts**:

```csharp
Enumerable.Range(1, 5).Select(index => new WeatherForecast
{
	Date = DateTime.Now.AddDays(index),
	TemperatureC = rng.Next(-20, 55),
	Summary = Summaries[rng.Next(Summaries.Length)]
})
```

One wil be a **ASP.NET Core API** project that we won't modify and leave it in state as it will be generated by the **Visual Studio** (so returning the results in shape as above). Second one will be **Azure Function** that by the end should behave in the same way as the first one.

1. Go to Visual Studio and open the solution file under the <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_folder_black_24px.svg" width="12" /> **./AzureFunctions/Demo/Begin/HTTP Trigger/Projects/Projects.sln** directory and start creating new project (**File** > **New Project...**)
2. Select:
   - new project's template: **ASP.NET Core Web Application**,
   - solution: **Add to solution**
   - project's name: **WebApplication1** (by default)
   - application template: **API** with disabled HTTPS (**Configure for HTTPS**),
3. create another project within same solution (**File** > **New Project...**):
   - new project's template: **Azure Functions**,
   - solution: **Add to solution**
   - project's name: **FunctionApp1** (by default)
   - application template: **HTTP Trigger** with other options as default,
4. execute <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **Replace-Port.bat** script (will replace randomly assigned port by Visual Studio).
5. At this point we should be able to run both scripts:
   - <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **WebApi.bat**,
   - <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **Http.bat**
6. and test with ![Postman Icon](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/postman-icon.png "Postman Icon")[Postman](https://www.postman.com). Within **Postman** load the collection for this solution (**Import** > **Choose Files** > <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **./AzureFunctions/Capgemini.Net AzureFunctions.postman_collection.json**). We have those requests to run:
   - ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") HTTP Trigger > HTTP Trigger [12] > Path > Before > ASP.NET Core API
   - ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") HTTP Trigger > HTTP Trigger [12] > Path > Before > Azure Function Function1.

At this point we can try to adjust our Azure Function project to resemble the first one. Things to to:

- [ ] make both request paths look the same as shown in requests:
  - ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") HTTP Trigger > HTTP Trigger [12] > Path > After > ASP.NET Core API
    - _http://localhost:{{dotnet-port}}/WeatherForecast_ > _http://localhost:{{dotnet-port}}/api/WeatherForecast_
  - ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") HTTP Trigger > HTTP Trigger [12] > Path > After > Azure Function WeatherForecast
    - _http://localhost:{{azure-func-port}}/api/Function1_ > _http://localhost:{{azure-func-port}}/api/WeatherForecast_.
- [ ] make both request accept only GET requests (so only two latest):
  - ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") HTTP Trigger > HTTP Trigger [12] > Methods > Before > ASP.NET Core API
  - ![POST](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/post.png "POST Method") HTTP Trigger > HTTP Trigger [12] > Methods > Before > ASP.NET Core API
  - ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") HTTP Trigger > HTTP Trigger [12] > Methods > Before > Azure Function
  - ![POST](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/post.png "POST Method") HTTP Trigger > HTTP Trigger [12] > Methods > Before > Azure Function
  - ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") HTTP Trigger > HTTP Trigger [12] > Methods > After > ASP.NET Core API
  - ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") HTTP Trigger > HTTP Trigger [12] > Methods > After > Azure Function
- [ ] make both request resturn the same result. We can find final project for this solution here: <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_folder_black_24px.svg" width="12" /> **.\AzureFunctions\Demo\Final\HTTP Trigger**

---

## HTTP Trigger + Cosmos DB Demo

This solution contains both applications from the first example but with persistent storage added (**Entity Framework Core 3** for **ASP.NET Core API** and **Azure Cosmos DB** for **Azure Function**). Both project should:

- [x] return **WeatherForecasts** entries stored in the DB on ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") request:
  - ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") HTTP Trigger > HTTP + DB [13] > ASP.NET Core API or
  - ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") HTTP Trigger > HTTP + DB [13] > Azure Function
- [x] store **howMany** (query parameter) randomly generated **WeatherForecasts** in the DB on ![POST](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/post.png "POST Method") request:
  - ![POST](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/post.png "POST Method") HTTP Trigger > HTTP + DB [13] > ASP.NET Core API or
  - ![POST](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/post.png "POST Method") HTTP Trigger > HTTP + DB [13] > Azure Function

We can find the final solution here: <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_folder_black_24px.svg" width="12" /> **./AzureFunctions/Demo/Final/HTTP + DB**.

To make the **Azure Function** project working we need to run <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **./AzureFunctions/Demo/Final/HTTP + DB/Set-Cosmos-DB-Connection-String.bat**. That script will connect to our Azure subscription and get all connection details to required Azure services.

At this point we should be able to run both scripts:

- <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **WebApi.bat**,
- <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **Http.bat**.

### Example

1. ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") _http://localhost:{{dotnet-port}}/api/WeatherForecast_

```javascript
[];
```

2. ![POST](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/post.png "POST Method") _http://localhost:{{dotnet-port}}/api/WeatherForecast?howMany=1_

```javascript
```

3. ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") _http://localhost:{{dotnet-port}}/api/WeatherForecast_

```javascript
[
  {
    date: "05.05.2020",
    temperatureC: -2,
    temperatureF: 29,
    summary: "Freezing",
  },
];
```

### Example

1. ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") _http://localhost:{{azure-func-port}}/api/WeatherForecast_

```javascript
[];
```

2. ![POST](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/post.png "POST Method") _http://localhost:{{azure-func-port}}/api/WeatherForecast?howMany=1_

```javascript
```

3. ![GET](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/get.png "GET Method") _http://localhost:{{azure-func-port}}/api/WeatherForecast_

```javascript
[
  {
    date: "05.05.2020",
    temperatureC: 29,
    temperatureF: 84,
    summary: "Chilly",
  },
];
```

## HTTP Trigger + Cosmos DB + Query + Blob Storage + SendGrid + Twilio Demo

This is the final solution that consists of two projects:

- **InitData** will generate some pre-defined documents for **Cosmos DB** and upload pre-defined invoice files to **Azure Blob Storage**,
- **HttpProcess** consists of one function that will:
  - be triggered by a ![POST](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/post.png "POST Method") **HTTP Trigger** with route parameter **guid** (invoice number),
  - read a document from the **Cosmos DB** containing info about selected **guid** invoice,
  - create stream object for the given invoice **{{guid}}.pdf** file,
  - send a text message for a given phone number about a new **guid** invoice,
  - send an email about the new **guid** invoice along with the **{{guid}}.pdf** file attached to that email.

We can find the final solution here: <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_folder_black_24px.svg" width="12" /> **./AzureFunctions/Demo/Final/HttpProcess**.

In order to run the solution we have to regenerate <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **.\InitData\appsettings.json** and <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **.\HttpProcess\local.settings.json** config files by runing <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **Set-App-Settings.bat** script. It will connect to our Azure subscription in order to download proper connection string settings and put them into configuration files.

In addition to those auto-generated settings we have to manually replaced values in the file <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **.\HttpProcess\local.settings.json**:

- SendGridApiKey = "SEND_GRID_API_KEY";
- TwilioAccountSid = "TWILIO_ACCOUNT_SID";
- TwilioAuthToken = "TWILIO_AUTH_TOKEN";

Both **SendGrid** and **Twilio** are external services so we cannot get required **API keys** from our Azure account. How to create and get required credentials we can read [here](https://www.twilio.com/azure) (for **Twilio**) and [here](https://docs.microsoft.com/en-us/azure/sendgrid-dotnet-how-to-send-email) (for **SendGrid**).

Both end files should look like those:

- [x] <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **.\InitData\appsettings.json**

```javascript
{
	"StorageAccount":  {
	   "BlobContainerName":  "invoices"
	},
	"ConnectionStrings":  {
		  "StorageAccount":  "DefaultEndpointsProtocol=https;AccountName=shortsfunchttpprocstore;AccountKey=********************;EndpointSuffix=core.windows.net",
		  "CosmosDB":  "AccountEndpoint=https://shortsfunchttpprocesscosmosdb.documents.azure.com:443/;AccountKey=********************;"
	  }
}
```

- [x] <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **.\InitData\appsettings.json**

```javascript
{
	"IsEncrypted":  false,
	"Values":  {
	   "TwilioAuthToken":  "********************",
	   "TwilioAccountSid":  "********************",
	   "FUNCTIONS_WORKER_RUNTIME":  "dotnet",
	   "SendGridApiKey":  "SG.********************",
	   "AzureWebJobsStorage":  "DefaultEndpointsProtocol=https;AccountName=shortsfunchttpprocstore;AccountKey=********************;EndpointSuffix=core.windows.net",
	   "CosmosDBConnectionString":  "AccountEndpoint=https://shortsfunchttpprocesscosmosdb.documents.azure.com:443/;AccountKey=********************;"
	}
}
```

There is also one more thing we need to setup. The target phone number for **Twilio** and target email for **SendGrid**. Those are sennsitive date so we have to put them as secrets. Go to **Visual Studio**, open <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **./AzureFunctions/Demo/Final/HttpProcess/HttpProcess.sln**, from the context menu for the **InitData** select **Manage User Secrects** and setup values for the given keys:

```javascript
{
  "mailTo": "**********@***.***",
  "phoneTo": "+48*********"
}
```

After all is set we have to run the <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **InitData.bat** script to populate both **AzureComsos DB** and **Azure Blob Storage**. 


In order the application to work, update in the same application the **Twilio** generated number (the **From** parameter from the **TwilioSms**** attribute in **SendInvoiceToCustomer.cs** file). Run <img src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_description_black_24px.svg" width="12" /> **HttpProcess.bat** to test the prepared configuration.

### Example

2. ![POST](https://github.com/PWrGitHub194238/Capgemini.NET/blob/master/AzureFunctions/README/post.png "POST Method") _http://localhost:{{azure-func-port}}/api/Send/A1129193095_

```javascript
Http Functions:

        SendInvoiceToCustomer: [POST] http://localhost:7071/api/Send/{guid}

Executing HTTP request: {
	"requestId": "f99845d8-ce41-4830-a2b6-c853671146d9",
	"method": "POST",
	"uri": "/api/Send/A1129193095"
}

Executing 'SendInvoiceToCustomer' (Reason='This function was programmatically called via the host APIs.',
Sending notifications for invoice: A1129193095...
Sending email notification for invoice: A1129193095...
Email for invoice: A1129193095 has been sent.
Sending text message notification for invoice: A1129193095...
Text notification for invoice: A1129193095 has been sent.
```

# Remember to remove all resource groups or subscribtion to avoid beeing charged!
